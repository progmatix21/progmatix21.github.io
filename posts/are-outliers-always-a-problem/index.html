<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Are Outliers Always a Problem? - Progmatix 21</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="Progmatix 21" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">Progmatix 21</div>
					<div class="logo__tagline">My learnings: byte by byte</div>
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Are Outliers Always a Problem?</h1>
			<p class="post__lead">no...sometimes we need to treat them with respect</p>
			<div class="post__meta meta">
<div class="meta__item-datetime meta__item">
	<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" class="meta__icon icon icon-calendar" width="18" height="16" 
	 viewBox="0 0 458 458" style="enable-background:new 0 0 458 458;" xml:space="preserve">
<g>
	<path d="M111.938,135.598c11.046,0,20-8.954,20-20V21.597c0-11.046-8.954-20-20-20s-20,8.954-20,20v94.001
		C91.938,126.644,100.892,135.598,111.938,135.598z"/>
	<path d="M346.063,135.598c11.046,0,20-8.954,20-20V21.597c0-11.046-8.954-20-20-20s-20,8.954-20,20v94.001
		C326.063,126.644,335.017,135.598,346.063,135.598z"/>
	<path d="M443,82.403h-46.938c0,12.42,0,20.918,0,33.195c0,27.614-22.386,50-50,50c-27.614,0-50-22.386-50-50
		c0-12.281,0-20.771,0-33.195H161.938c0,12.42,0,20.918,0,33.195c0,27.614-22.386,50-50,50c-27.614,0-50-22.386-50-50
		c0-12.281,0-20.771,0-33.195H15c-8.284,0-15,6.716-15,15v89.641h458V97.403C458,89.119,451.284,82.403,443,82.403z"/>
	<path d="M0,441.403c0,8.284,6.716,15,15,15h428c8.284,0,15-6.716,15-15V227.044H0V441.403z M244.191,313.046
		c0-6.036,3.59-11.504,9.127-13.907c7.49-3.249,16.316-9.028,21.176-13.393c2.782-2.499,6.38-3.88,10.121-3.88h19.254
		c4.395,0,7.957,3.563,7.957,7.958v80.903h11.445c8.275,0,14.984,6.708,14.984,14.984c0,8.275-6.708,14.984-14.984,14.984h-59.934
		c-8.275,0-14.984-6.708-14.984-14.984c0-8.275,6.708-14.984,14.984-14.984h14.567V317.66c-2.163,2.886-6.797,6.077-12.243,8.754
		c-4.618,2.27-10.076,2.008-14.445-0.711c-4.369-2.718-7.025-7.501-7.025-12.647V313.046z M123.295,390.677
		c2.691-29.175,18.127-37.168,47.125-52.83c4.622-2.493,12.811-7.06,15.92-11.134c3.842-5.044,1.97-18.001-14.359-18.001
		c-5.549,0-11.094,1.106-17.704,5.967c-6.262,4.605-14.984,3.637-20.067-2.244l-0.594-0.688c-3.026-3.501-4.246-8.216-3.31-12.747
		s3.925-8.371,8.09-10.387c22.329-10.811,56.654-13.101,73.853,0.952c7.977,6.523,11.966,15.332,11.966,26.43
		c0,32.434-40.129,38.997-54.315,54.731h41.622c8.275,0,14.984,6.708,14.984,14.984c0,8.275-6.708,14.984-14.984,14.984h-79.1
		c-2.577,0-5.036-1.095-6.772-3C123.914,395.789,123.059,393.243,123.295,390.677z"/>
</g>
</svg>
<time class="meta__text" datetime="2024-01-17T11:14:16&#43;05:30">January 17, 2024</time></div>
<div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2l1 2h8v11h-16v-13z"/></svg><span class="meta__text"><a class="meta__link" href="/categories/data-science/" rel="category">Data Science</a>
	</span>
</div><div class="meta__item-categories meta__item">
	<span class="meta__text">
		<svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg>436 words/3 min read
	</span>
</div>
</div>
		</header>
		
<div class="content post__content clearfix">
			
<style>
#myBtn {
  display: none;
  position: fixed;
  bottom: 20px;
  right: 30px;
  z-index: 99;
  font-size: 36px;
  font-weight: bold;
  border: none;
  outline: none;
  background-color: #444;
  color: white;
  cursor: pointer;
  padding: 15px;
  border-radius: 50%;
}

#myBtn:hover {
  background-color: #008080;
}
</style>

<button onclick="topFunction()" id="myBtn" title="Go to top">&#9650;</button>


<script>

let mybutton = document.getElementById("myBtn");


window.onscroll = function() {scrollFunction()};

function scrollFunction() {
  if (document.body.scrollTop > 1000 || document.documentElement.scrollTop > 1000) {
    mybutton.style.display = "block";
  } else {
    mybutton.style.display = "none";
  }
}


function topFunction() {
  document.body.scrollTop = 0;
  document.documentElement.scrollTop = 0;
}
</script>



<p>The subject dataset is a highly imbalanced, labelled credit card fraud detection
data.  The 5-point summary indicated the presence of extreme outliers.<br>
The initial approach was to take a hard attitude towards the outliers
and limit them using the 1.5*IQR rule.  This gave us poor results.</p>
<p>We wrote a custom data prep function that was tunable via grid search.  We
found that we got the best recall for the widest quantile range that contained most
of the outliers.</p>
<p>Below is a code fragment with the custom data-prep function.  For the complete
code in context refer to my <a href="https://www.kaggle.com/code/atrijtalgery/tuned-dataprep-pipeline-gives-80-recall">Kaggle notebook</a>.</p>
<div class="highlight"><div style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="display:block;width:100%;background-color:#e5e5e5"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span></span><span style="display:block;width:100%;background-color:#e5e5e5"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span></span><span style="display:block;width:100%;background-color:#e5e5e5"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span></span><span style="display:block;width:100%;background-color:#e5e5e5"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span></span><span style="display:block;width:100%;background-color:#e5e5e5"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span></span><span style="display:block;width:100%;background-color:#e5e5e5"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span></span><span style="display:block;width:100%;background-color:#e5e5e5"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span></span><span style="display:block;width:100%;background-color:#e5e5e5"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#008000;font-weight:bold">def</span> <span style="color:#00f">outlier_limiter_compressor</span>(Xdf, amtx<span style="color:#666">=</span><span style="color:#ba2121">&#39;log&#39;</span>, v1_28x<span style="color:#666">=</span><span style="color:#ba2121">&#39;custom&#39;</span>, qrange<span style="color:#666">=</span>(<span style="color:#666">0.10</span>,<span style="color:#666">0.90</span>)):
    <span style="color:#ba2121">&#39;&#39;&#39;Input dataframe for transformation. 2 options to transform `Amount` and 3 transform `V1 to V28` &#39;&#39;&#39;</span>
    cXdf <span style="color:#666">=</span> Xdf<span style="color:#666">.</span>copy()
    
    <span style="color:#008000;font-weight:bold">if</span> v1_28x <span style="color:#666">==</span> <span style="color:#ba2121">&#39;custom&#39;</span>:
        <span style="color:#008000;font-weight:bold">for</span> col <span style="color:#a2f;font-weight:bold">in</span> V1_28:     <span style="color:#408080;font-style:italic"># apply outlier limits to each column</span>
            qlo,qhi <span style="color:#666">=</span> cXdf[col]<span style="color:#666">.</span>quantile([qrange[<span style="color:#666">0</span>],qrange[<span style="color:#666">1</span>]])<span style="color:#666">.</span>values
            lowr,uppr <span style="color:#666">=</span> qlo<span style="color:#666">-</span>(qhi<span style="color:#666">-</span>qlo)<span style="color:#666">*</span><span style="color:#666">1.5</span>, qhi<span style="color:#666">+</span>(qhi<span style="color:#666">-</span>qlo)<span style="color:#666">*</span><span style="color:#666">1.5</span>
            <span style="color:#408080;font-style:italic"># Hard limit outliers using 1.5 inter quantile rule</span>
            cXdf[col] <span style="color:#666">=</span> cXdf[col]<span style="color:#666">.</span>map(<span style="color:#008000;font-weight:bold">lambda</span> x: lowr <span style="color:#008000;font-weight:bold">if</span> x <span style="color:#666">&lt;</span> lowr <span style="color:#008000;font-weight:bold">else</span> uppr <span style="color:#008000;font-weight:bold">if</span> x<span style="color:#666">&gt;</span>uppr <span style="color:#008000;font-weight:bold">else</span> x)
    <span style="color:#008000;font-weight:bold">elif</span> v1_28x <span style="color:#666">==</span> <span style="color:#ba2121">&#39;standard&#39;</span>:
        scaler <span style="color:#666">=</span> StandardScaler()
        cXdf[V1_28] <span style="color:#666">=</span> scaler<span style="color:#666">.</span>fit_transform(cXdf[V1_28])        
    <span style="color:#008000;font-weight:bold">elif</span> v1_28x <span style="color:#666">==</span> <span style="color:#ba2121">&#39;robust&#39;</span>:
        scaler <span style="color:#666">=</span> RobustScaler(quantile_range<span style="color:#666">=</span>(qrange[<span style="color:#666">0</span>]<span style="color:#666">*</span><span style="color:#666">100</span>,qrange[<span style="color:#666">1</span>]<span style="color:#666">*</span><span style="color:#666">100</span>))
        cXdf[V1_28] <span style="color:#666">=</span> scaler<span style="color:#666">.</span>fit_transform(cXdf[V1_28])
    <span style="color:#008000;font-weight:bold">else</span>:
        <span style="color:#008000;font-weight:bold">raise</span> <span style="color:#d2413a;font-weight:bold">ValueError</span>(<span style="color:#ba2121">&#34;Invalid option for v1_28x: Use &#39;custom&#39;,&#39;standard&#39; or &#39;robust&#39;&#34;</span>)
<span style="display:block;width:100%;background-color:#e5e5e5">        
</span><span style="display:block;width:100%;background-color:#e5e5e5">    <span style="color:#408080;font-style:italic"># Now transform the Amount column to log</span>
</span><span style="display:block;width:100%;background-color:#e5e5e5">    <span style="color:#008000;font-weight:bold">if</span> amtx <span style="color:#666">==</span> <span style="color:#ba2121">&#39;log&#39;</span>:
</span><span style="display:block;width:100%;background-color:#e5e5e5">        cXdf[<span style="color:#ba2121">&#39;Amount&#39;</span>] <span style="color:#666">=</span> cXdf[<span style="color:#ba2121">&#39;Amount&#39;</span>]<span style="color:#666">.</span>map(<span style="color:#008000;font-weight:bold">lambda</span> x: np<span style="color:#666">.</span>log10(x) <span style="color:#008000;font-weight:bold">if</span> x<span style="color:#666">&gt;</span><span style="color:#666">1</span> <span style="color:#008000;font-weight:bold">else</span> x)
</span><span style="display:block;width:100%;background-color:#e5e5e5">    <span style="color:#008000;font-weight:bold">elif</span> amtx <span style="color:#666">==</span> <span style="color:#ba2121">&#39;minmax&#39;</span>:
</span><span style="display:block;width:100%;background-color:#e5e5e5">        <span style="color:#408080;font-style:italic"># Or try the minmax scaler</span>
</span><span style="display:block;width:100%;background-color:#e5e5e5">        mmscaler <span style="color:#666">=</span> MinMaxScaler()
</span><span style="display:block;width:100%;background-color:#e5e5e5">        cXdf[<span style="color:#ba2121">&#39;Amount&#39;</span>] <span style="color:#666">=</span> mmscaler<span style="color:#666">.</span>fit_transform(cXdf[<span style="color:#ba2121">&#39;Amount&#39;</span>]<span style="color:#666">.</span>values<span style="color:#666">.</span>reshape(<span style="color:#666">-</span><span style="color:#666">1</span>,<span style="color:#666">1</span>))
</span>    <span style="color:#008000;font-weight:bold">else</span>:
        <span style="color:#008000;font-weight:bold">raise</span> <span style="color:#d2413a;font-weight:bold">ValueError</span>(<span style="color:#ba2121">&#34;Invalid option for amtx: Use &#39;log&#39; or &#39;minmax&#39;&#34;</span>)
    <span style="color:#008000;font-weight:bold">return</span> cXdf</code></pre></td></tr></table>
</div>
</div>
<h2 id="takeaway">Takeaway</h2>
<p>We achieved a recall of 80+% using a tuned data prep pipeline (using our custom
function above) along with a class-weighted random forest ensemble for this heavily
imbalanced (0.0017%) dataset.
One important learning is that for a heavily imbalanced dataset, outliers need to
be treated with care &ndash; they cannot be automatically removed, but their effect
needs to be studied/mitigated (say by compressing them to a log scale) to suit
the model.  Perhaps, the outliers hold the key to the positive cases.</p>

		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5 0 11V3C0 1.5.8.8.8.8S1.5 0 3 0h8c1.5 0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>
	<ul class="tags__list">
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/outliers/" rel="tag">outliers</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/classification/" rel="tag">classification</a>
		</li>
	</ul>
</div>
		</footer>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/calibrate-your-classifier/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Calibrate Your Classifier</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/regressor-as-classifier/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Regressor as Classifier</p>
		</a>
	</div>
</nav>




			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
<div class="footer__links">
	<a class="footer__link" href="/about/">About</a>
</div>
		<div class="footer__copyright">
			&copy; 2024 Atrij Talgery.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async></script>
</body>
</html>